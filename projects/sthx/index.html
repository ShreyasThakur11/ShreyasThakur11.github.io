<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional STHX Design | Shreyas Thakur</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../dphx/style.css">
    <style>
        /* Extra styles for Pro Tool */
        .mode-switch {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: rgba(30, 41, 59, 0.5);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .mode-option {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 600;
            color: #94a3b8;
        }

        .mode-option.active {
            background: var(--primary-color);
            color: #0f172a;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
        }

        .rating-only {
            display: none;
        }

        .design-mode .rating-only {
            display: none;
        }

        .rating-mode .rating-only {
            display: block;
            animation: fadeIn 0.5s;
        }

        .design-only {
            display: block;
        }

        .rating-mode .design-only {
            display: none;
        }
    </style>
</head>

<body>
    <nav>
        <a href="../../index.html" class="logo">Shreyas</a>
        <div class="nav-links">
            <a href="../../index.html">Home</a>
            <a href="../../index.html#projects" class="active">Projects</a>
            <a href="../../contact.html">Comm Link</a>
        </div>
    </nav>

    <main class="project-container">
        <header class="project-header">
            <div style="margin-bottom: 1rem; font-size: 0.9rem;">
                <a href="../dphx/index.html" style="color: var(--secondary-color); text-decoration: none;">&larr; Switch
                    to Double Pipe</a>
            </div>
            <h1>Professional Shell & Tube Design</h1>
            <p>Rigorous Design Engine & Rating Tool (Kern Method)</p>
        </header>

        <div class="calc-grid">
            <!-- INPUTS -->
            <form id="designForm" class="input-panel card">

                <!-- Mode Switch -->
                <div class="input-group full-width">
                    <h3><span class="icon">‚öôÔ∏è</span> Operation Mode</h3>
                    <div class="mode-switch">
                        <div class="mode-option active" onclick="setMode('design')">Design Mode (Auto-Geometry)</div>
                        <div class="mode-option" onclick="setMode('rating')">Rating Mode (Manual)</div>
                    </div>
                    <input type="hidden" name="mode" id="modeInput" value="design">
                </div>

                <!-- Fluid Allocation -->
                <div class="input-group full-width">
                    <h3><span class="icon">üîÑ</span> Configuration</h3>
                    <div class="row">
                        <label style="flex:2;">Fluid Allocation
                            <select name="fluid_allocation" id="alloc_select">
                                <option value="auto">Auto-Recommend (Smart Logic)</option>
                                <option value="hot_shell">Hot Fluid in Shell</option>
                                <option value="cold_shell">Cold Fluid in Shell</option>
                            </select>
                        </label>
                    </div>
                </div>

                <!-- FLUIDS -->
                <div class="row" style="gap: 2rem;">
                    <!-- HOT FLUID -->
                    <div class="input-group" style="flex:1;">
                        <h3><span class="icon">üî•</span> Hot Fluid</h3>
                        <label>Select Fluid <select id="hot_fluid_select" onchange="autoFillProps('hot', this.value)">
                                <option value="user_defined">User Defined</option>
                            </select></label>
                        <label>Mass Flow (kg/s) <input type="number" step="any" name="m_h"
                                placeholder="Opt. if temps known"></label>
                        <label>Inlet Temp (¬∞C) <input type="number" step="any" name="T_h_in" required></label>
                        <label>Outlet Temp (¬∞C) <input type="number" step="any" name="T_h_out"
                                placeholder="Opt. if Cold Out known"></label>
                        <label>Cp (J/kg.K) <input type="number" step="any" name="cp_h" id="h_cp" required></label>
                        <label>Density (kg/m¬≥) <input type="number" step="any" name="rho_h" id="h_rho" required></label>
                        <label>Viscosity (Pa.s) <input type="number" step="any" name="mu_h" id="h_mu" required></label>
                        <label>Thermal Cond. (W/m.K) <input type="number" step="any" name="k_h" id="h_k"
                                required></label>
                        <label>Fouling Factor <input type="number" step="any" name="rf_h" id="h_rf"
                                value="0.0002"></label>
                    </div>

                    <!-- COLD FLUID -->
                    <div class="input-group" style="flex:1;">
                        <h3><span class="icon">‚ùÑÔ∏è</span> Cold Fluid</h3>
                        <label>Select Fluid <select id="cold_fluid_select" onchange="autoFillProps('cold', this.value)">
                                <option value="user_defined">User Defined</option>
                            </select></label>
                        <label>Mass Flow (kg/s) <input type="number" step="any" name="m_c"
                                placeholder="Opt. if temps known"></label>
                        <label>Inlet Temp (¬∞C) <input type="number" step="any" name="T_c_in" required></label>
                        <label>Outlet Temp (¬∞C) <input type="number" step="any" name="T_c_out"
                                placeholder="Opt. if Hot Out known"></label>
                        <label>Cp (J/kg.K) <input type="number" step="any" name="cp_c" id="c_cp" required></label>
                        <label>Density (kg/m¬≥) <input type="number" step="any" name="rho_c" id="c_rho" required></label>
                        <label>Viscosity (Pa.s) <input type="number" step="any" name="mu_c" id="c_mu" required></label>
                        <label>Thermal Cond. (W/m.K) <input type="number" step="any" name="k_c" id="c_k"
                                required></label>
                        <label>Fouling Factor <input type="number" step="any" name="rf_c" id="c_rf"
                                value="0.0002"></label>
                    </div>
                </div>

                <!-- GEOMETRY -->
                <div class="input-group full-width">
                    <h3><span class="icon">üìê</span> Exchanger Geometry</h3>

                    <div class="row">
                        <!-- Common settings -->
                        <div style="flex:1;">
                            <label>Tube OD (m) <input type="number" step="any" name="tube_od" value="0.01905"
                                    required></label>
                            <label>Tube ID (m) <input type="number" step="any" name="tube_id" value="0.01575"
                                    required></label>
                            <label>Tube Length (m) <input type="number" step="any" name="tube_length" value="3.0"
                                    required></label>
                        </div>
                        <div style="flex:1;">
                            <label>Tube Pitch (m) <input type="number" step="any" name="tube_pitch" value="0.0238"
                                    required></label>
                            <label>Pitch Type
                                <select name="pitch_type">
                                    <option value="triangular">Triangular (30¬∞)</option>
                                    <option value="square">Square (90¬∞)</option>
                                </select>
                            </label>
                            <label>Tube Passes <input type="number" step="any" name="tube_passes" value="2"
                                    required></label>
                        </div>
                    </div>

                    <div class="design-only"
                        style="margin-top:1rem; border-top:1px dashed var(--glass-border); padding-top:1rem;">
                        <h4 style="color:var(--accent-color);">Design Constraints</h4>
                        <label>Initial Guess U (W/m¬≤K) <input type="number" name="U_guess" value="500"></label>
                    </div>

                    <div class="rating-only"
                        style="margin-top:1rem; border-top:1px dashed var(--glass-border); padding-top:1rem;">
                        <h4 style="color:var(--secondary-color);">Detailed Geometry (Rating Mode)</h4>
                        <div class="row">
                            <label>Shell Diameter (m) <input type="number" step="any" name="shell_ID"
                                    value="0.5"></label>
                            <label>Total Tubes <input type="number" name="total_tubes" value="100"></label>
                        </div>
                        <div class="row">
                            <label>Baffle Spacing (m) <input type="number" step="any" name="baffle_spacing"
                                    value="0.2"></label>
                            <label>Baffle Cut (%) <input type="number" step="any" name="baffle_cut"
                                    value="0.25"></label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="cta-button primary full-width" id="calcBtn">Run Design Iteration</button>
            </form>

            <!-- OUTPUTS -->
            <div class="output-panel">
                <div id="results" class="card result-card hidden">
                    <h3>Results Summary</h3>

                    <div style="text-align:center; margin-bottom:1rem;">
                        <span id="converge-badge" class="badge">Processing...</span>
                    </div>

                    <div class="result-grid">
                        <div class="result-item"><span>Heat Duty (Q)</span><strong id="res-Q">-</strong></div>
                        <div class="result-item"><span>Area Required</span><strong id="res-Areq">-</strong></div>
                        <div class="result-item"><span>Calculated U</span><strong id="res-U">-</strong></div>
                        <div class="result-item"><span>LMTD</span><strong id="res-LMTD">-</strong></div>
                    </div>

                    <h4>Final Geometry</h4>
                    <div class="result-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="result-item"><span>Shell Dia</span><strong id="res-Ds"
                                style="color:var(--secondary-color);">-</strong></div>
                        <div class="result-item"><span>Tubes</span><strong id="res-Nt"
                                style="color:var(--secondary-color);">-</strong></div>
                        <div class="result-item"><span>Baffle Spacing</span><strong id="res-B"
                                style="color:var(--secondary-color);">-</strong></div>
                    </div>

                    <h4>Detailed Performance</h4>
                    <table class="tech-table">
                        <thead>
                            <tr>
                                <th>Param</th>
                                <th>Shell Side</th>
                                <th>Tube Side</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Fluid</td>
                                <td id="res-fl-s">-</td>
                                <td id="res-fl-t">-</td>
                            </tr>
                            <tr>
                                <td>Velocity (m/s)</td>
                                <td id="res-v-s">-</td>
                                <td id="res-v-t">-</td>
                            </tr>
                            <tr>
                                <td>Reynolds No.</td>
                                <td id="res-re-s">-</td>
                                <td id="res-re-t">-</td>
                            </tr>
                            <tr>
                                <td>HTC (h)</td>
                                <td id="res-h-s">-</td>
                                <td id="res-h-t">-</td>
                            </tr>
                            <tr>
                                <td>Press Drop (kPa)</td>
                                <td id="res-dp-s">-</td>
                                <td id="res-dp-t">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card log-card">
                    <h3>Engineering Log</h3>
                    <div id="logs" class="log-console">
                        <p class="placeholder">Waiting for input...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // INIT
        const fluidSelects = ['hot_fluid_select', 'cold_fluid_select'];

        // Populate Dropdowns
        function initFluids() {
            fluidSelects.forEach(id => {
                const sel = document.getElementById(id);
                // Clear existing except user defined
                sel.innerHTML = '<option value="user_defined">User Defined</option>';

                Object.keys(FLUID_DB).forEach(key => {
                    if (key === 'user_defined') return;
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = FLUID_DB[key].name;
                    sel.appendChild(opt);
                });
            });
        }

        function autoFillProps(side, key) {
            const f = FLUID_DB[key];
            if (!f) return;
            const prefix = side === 'hot' ? 'h_' : 'c_';

            document.getElementById(prefix + 'cp').value = f.cp;
            document.getElementById(prefix + 'rho').value = f.rho;
            document.getElementById(prefix + 'mu').value = f.mu;
            document.getElementById(prefix + 'k').value = f.k;
            document.getElementById(prefix + 'rf').value = f.fouling;
        }

        function setMode(mode) {
            document.getElementById('modeInput').value = mode;
            const form = document.querySelector('.input-panel');
            const btn = document.getElementById('calcBtn');

            // UI Toggle
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            if (mode === 'design') {
                document.querySelectorAll('.mode-option')[0].classList.add('active');
                form.classList.remove('rating-mode');
                form.classList.add('design-mode');
                btn.textContent = "Run Design Iteration";
            } else {
                document.querySelectorAll('.mode-option')[1].classList.add('active');
                form.classList.remove('design-mode');
                form.classList.add('rating-mode');
                btn.textContent = "Calculate Rating";
            }
        }

        // Form Submit
        document.getElementById('designForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};

            // Parse numbers carefully
            for (let [key, val] of formData.entries()) {
                if (["allocation", "pitch_type", "mode", "fluid_allocation"].includes(key)) {
                    data[key] = val;
                } else {
                    data[key] = parseFloat(val);
                }
            }

            // Construct nested fluid objects
            data.hot = {
                m: data.m_h, Tin: data.T_h_in, Tout: data.T_h_out,
                cp: data.cp_h, rho: data.rho_h, mu: data.mu_h, k: data.k_h, fouling: data.rf_h
            };
            data.cold = {
                m: data.m_c, Tin: data.T_c_in, Tout: data.T_c_out,
                cp: data.cp_c, rho: data.rho_c, mu: data.mu_c, k: data.k_c, fouling: data.rf_c
            };

            // Run Calculation
            const res = calculateSTHX_Pro(data);

            // Render Logs
            const logBox = document.getElementById('logs');
            logBox.innerHTML = '';
            if (res.logs) {
                res.logs.forEach(l => {
                    const p = document.createElement('p');
                    p.textContent = typeof l === 'string' ? l : JSON.stringify(l);
                    if (l.includes('Iter')) p.style.color = '#94a3b8';
                    if (l.includes('Error') || l.includes('‚ö†Ô∏è')) p.style.color = '#ef4444';
                    if (l.includes('Converged') || l.includes('Success')) p.style.color = '#10b981';
                    logBox.appendChild(p);
                });
            }

            if (res.error) {
                logBox.innerHTML += `<p class="error">CRITICAL ERROR: ${res.error}</p>`;
                return;
            }

            // Render Results
            document.getElementById('results').classList.remove('hidden');

            const badge = document.getElementById('converge-badge');
            if (res.converged || (data.mode === 'rating')) {
                badge.textContent = data.mode === 'design' ? "Converged Solution Found" : "Rating Complete";
                badge.className = "badge success";
            } else {
                badge.textContent = "Not Converged / Warnings";
                badge.className = "badge warning";
            }

            document.getElementById('res-Q').textContent = (res.Q / 1000).toFixed(1) + " kW";
            document.getElementById('res-Areq').textContent = res.Area_Required.toFixed(2) + " m¬≤";
            document.getElementById('res-U').textContent = res.U_dirty.toFixed(1) + " W/m¬≤K";
            document.getElementById('res-LMTD').textContent = res.LMTD.toFixed(1) + " ¬∞C";

            document.getElementById('res-Ds').textContent = (res.Geometry.Ds * 1000).toFixed(0) + " mm";
            document.getElementById('res-Nt').textContent = res.Geometry.Nt;
            document.getElementById('res-B').textContent = (res.Geometry.B * 1000).toFixed(0) + " mm";

            // Tables
            document.getElementById('res-v-s').textContent = res.Vs.toFixed(2);
            document.getElementById('res-v-t').textContent = res.Vt.toFixed(2);
            document.getElementById('res-re-s').textContent = res.Re_s.toFixed(0);
            document.getElementById('res-re-t').textContent = res.Re_t.toFixed(0);
            document.getElementById('res-h-s').textContent = res.h_s.toFixed(1);
            document.getElementById('res-h-t').textContent = res.h_t.toFixed(1);
            document.getElementById('res-dp-s').textContent = (res.dP_s / 1000).toFixed(2);
            document.getElementById('res-dp-t').textContent = (res.dP_t / 1000).toFixed(2);

        });

        // Initialize
        initFluids();
        setMode('design'); // Default to design
    </script>
</body>

</html>